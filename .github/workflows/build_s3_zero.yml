name: Build RNode S3 Zero

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Official Firmware
        uses: actions/checkout@v3
        with:
          repository: markqvist/RNode_Firmware
          ref: master
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install PlatformIO
        run: pip install platformio

      - name: Prepare Project Structure
        run: |
          mkdir -p src
          mkdir -p lib
          find . -maxdepth 1 -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.ino" \) -exec mv {} src/ \;
          if [ -d "Libraries" ]; then cp -r Libraries/* lib/ 2>/dev/null || true; fi
          if [ -d "libraries" ]; then cp -r libraries/* lib/ 2>/dev/null || true; fi
          FOUND_FILE=$(find . -name "Ed25519.h" -print -quit)
          if [ -n "$FOUND_FILE" ]; then
            LIB_PATH=$(dirname "$FOUND_FILE")
            if [[ "$LIB_PATH" != *"lib"* ]]; then cp -r "$LIB_PATH" lib/Ed25519_Lib; fi
          fi
          rm -f platformio.ini

      - name: Patch Firmware (Trojan Horse Method)
        run: |
          echo "Patching Radio Driver..."
          sed -i '/bool SX126x::begin/a \ \ dio3TcxoVoltage = 1.8;\n\ \ useDio2AsRfSwitch = true;' src/sx126x.cpp
          
          echo "Creating S3-Zero Definition Header..."
          # This header provides exactly what the compiler is missing, matching the firmware's expected types.
          cat <<EOT > src/s3_zero_def.h
            #include <Arduino.h>
            #include <EEPROM.h>
            
            // --- Platform Definitions ---
            // We verify if they exist before defining to avoid "Redefined" warnings
            #ifndef PLATFORM_ESP32
            #define PLATFORM_ESP32 0x80
            #endif
            
            #ifndef PLATFORM
            #define PLATFORM PLATFORM_ESP32
            #endif
            
            // --- Hardware Pins (S3-Zero) ---
            #define PIN_LORA_SCK 13
            #define PIN_LORA_MISO 12
            #define PIN_LORA_MOSI 11
            #define PIN_LORA_NSS 10
            #define PIN_LORA_DIO_1 4
            #define PIN_LORA_BUSY 5
            #define PIN_LORA_RESET 6
            
            // --- LED Pins ---
            // We declare these as variables because Utilities.h expects to read them
            const int pin_led_rx = 21;
            const int pin_led_tx = 21;
            const int pin_led_status = 21;
            
            // --- Helper Macros ---
            // We only define these if they don't conflict with functions
            #define led_rx_on() digitalWrite(pin_led_rx, HIGH)
            #define led_rx_off() digitalWrite(pin_led_rx, LOW)
            #define led_tx_on() digitalWrite(pin_led_tx, HIGH)
            #define led_tx_off() digitalWrite(pin_led_tx, LOW)
            
            // --- Globals/Memory ---
            #define INFO_LOCK_BYTE 0x00 
            
            // Match the size expected by Device.h (128) to prevent conflict errors
            #ifdef EEPROM_SIG_LEN
            #undef EEPROM_SIG_LEN
            #endif
            #define EEPROM_SIG_LEN 128
            
            #ifndef EEPROM_SIZE
            #define EEPROM_SIZE 512
            #endif
            
            // Declare global variables required by Utilities.h
            uint8_t lock_byte;
            uint8_t dev_eeprom_signature[EEPROM_SIG_LEN];
          EOT
          
          echo "Injecting Header into Boards.h..."
          # Replace the error line with our include.
          sed -i 's|#error An unsupported ESP32 board was selected. Cannot compile RNode firmware.|#include "s3_zero_def.h"|' src/Boards.h
          
          echo "Patches applied."

      - name: Create S3-Zero Config
        run: |
          cat <<'EOF' > platformio.ini
          [platformio]
          default_envs = custom_s3_zero
          src_dir = src
          lib_dir = lib

          [env:custom_s3_zero]
          platform = espressif32
          board = esp32-s3-devkitc-1
          framework = arduino
          monitor_speed = 115200
          
          ; --- MEMORY SETTINGS ---
          board_build.arduino.memory_type = qio_qspi
          board_build.flash_mode = qio
          board_build.psram_type = qio
          board_build.mcu = esp32s3
          board_build.f_cpu = 240000000L
          board_build.f_flash = 80000000L
          board_upload.flash_size = 4MB
          board_build.partitions = default.csv
          
          build_flags = 
            -D ARDUINO_USB_CDC_ON_BOOT=1
            -D ARDUINO_USB_MSC_ON_BOOT=0
            -D ARDUINO_USB_DFU_ON_BOOT=0
            -D ARDUINO_USB_MODE=1
            -D ESP32S3
            
            ; Use Fake ID (0xFE) to trigger the #else block we patched
            -D BOARD_ESP32_S3_GENERIC
            -D BOARD_MODEL=0xFE 
            -D RADIO_SX1262
            
            ; NeoPixel Support
            -D HAS_NEOPIXEL
            -D NEOPIXEL_COUNT=1
            -D NEOPIXEL_DATA=21
            -D NEOPIXEL_TYPE=NEO_GRB+NEO_KHZ800
            
          lib_deps = 
            adafruit/Adafruit SSD1306 @ ^2.5.7
            adafruit/Adafruit GFX Library @ ^1.11.5
            adafruit/Adafruit BusIO @ ^1.14.1
            adafruit/Adafruit NeoPixel @ ^1.11.0
            rweather/Crypto @ ^0.4.0
          EOF

      - name: Build Firmware
        run: pio run -e custom_s3_zero

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware_bin
          path: .pio/build/custom_s3_zero/firmware.bin
